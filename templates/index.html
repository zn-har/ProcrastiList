{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcrastiList - Your Digital Notes</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="notebook-wrapper">
        <div class="notebook-page">
            <!-- Notebook Header -->
            <header class="notebook-header">
                <div class="notebook-title">
                    <h1><i class="fas fa-sticky-note"></i> ProcrastiList</h1>
                    <p class="notebook-subtitle">Your digital notepad</p>
                </div>
                <div class="notebook-controls">
                    {% if user.is_authenticated %}
                        <span class="user-greeting">Hello, {{ user.first_name|default:user.username }}!</span>
                        <a href="{% url 'logout' %}" class="control-btn logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    {% endif %}
                </div>
            </header>

            <!-- Quick Add Note -->
            <div class="quick-note-section">
                <div class="quick-note-header">
                    <h2><i class="fas fa-pencil-alt"></i> Quick Add</h2>
                </div>
                <form method="post" class="quick-note-form" action="">
                    {% csrf_token %}
                    <div class="note-input-group">
                        <textarea name="task" placeholder="What's on your mind?" rows="3" required></textarea>
                        <div class="note-controls">
                            <select name="priority" class="priority-select">
                                <option value="LOW">ðŸŸ¢ Low</option>
                                <option value="MEDIUM" selected>ðŸŸ¡ Medium</option>
                                <option value="HIGH">ðŸ”´ High</option>
                            </select>
                            <div class="deadline-input-wrapper">
                                <label for="deadline-input" class="deadline-label">
                                    <i class="fas fa-calendar-alt"></i> Deadline:
                                </label>
                                <input type="datetime-local" name="deadline" id="deadline-input" class="deadline-input" required>
                            </div>
                            <button type="submit" class="add-note-btn">
                                <i class="fas fa-plus"></i> Add Note
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Notes Collection -->
            <div class="notes-collection">
                <div class="collection-header">
                    <h2><i class="fas fa-layer-group"></i> Your Notes</h2>
                    <div class="view-controls">
                        <button class="view-btn active" data-view="grid"><i class="fas fa-th"></i></button>
                        <button class="view-btn" data-view="list"><i class="fas fa-list"></i></button>
                    </div>
                </div>
                
                <div class="notes-grid" id="notesContainer">
                    {% for todo in todos %}
                    <div class="sticky-note {% if todo.completed %}completed{% endif %} priority-{{ todo.priority|lower }}" data-todo-id="{{ todo.id }}">
                        <div class="note-corner"></div>
                            {% if todo.deadline %}
                                <div class="note-deadline{% if todo.deadline < now and not todo.completed %} overdue{% endif %}" data-deadline="{{ todo.deadline|date:'c' }}">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span class="deadline-date">{{ todo.deadline|date:"M d, Y g:i A" }}</span>
                                    <span class="time-remaining"></span>
                                    {% if todo.deadline < now and not todo.completed %}
                                        <span class="overdue-label">OVERDUE</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div class="note-content">
                                <p class="note-text">{{ todo.task }}</p>

                                {% if todo.d1 or todo.d2 %}
                                    <div class="note-distractions">
                                        {% if todo.d1 %}
                                            <p class="distraction-item"><strong>.</strong> {{ todo.d1 }}</p>
                                        {% endif %}
                                        {% if todo.d2 %}
                                            <p class="distraction-item"><strong>.</strong> {{ todo.d2 }}</p>
                                        {% endif %}
                                    </div>
                                {% endif %}

                            </div>
                            <div class="note-footer">
                                <div class="note-meta">
                                    <span class="priority-dot priority-{{ todo.priority|lower }}"></span>
                                    <span class="note-date">Today</span>
                                </div>
                                <div class="note-actions">
                                    <button class="note-action-btn complete-btn {% if todo.completed %}completed{% endif %}" 
                                            onclick="toggleTodoCompletion({{ todo.id }})">
                                        <i class="fas {% if todo.completed %}fa-undo{% else %}fa-check{% endif %}"></i>
                                    </button>
                                    <form method="post" action="{% url 'delete_todo' todo.id %}" class="inline-form">
                                        {% csrf_token %}
                                        <button type="submit" class="note-action-btn delete-btn" 
                                                onclick="return confirm('Delete this note?')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-notebook">
                            <div class="empty-illustration">
                                <i class="fas fa-sticky-note"></i>
                            </div>
                            <h3>Your notebook is empty</h3>
                            <p>Start by adding your first note above</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to calculate time remaining
        function calculateTimeRemaining(deadline) {
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const timeDiff = deadlineDate - now;
            
            if (timeDiff <= 0) {
                return null; // Overdue or passed
            }
            
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} left`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''} left`;
            } else if (minutes > 0) {
                return `${minutes} minute${minutes > 1 ? 's' : ''} left`;
            } else {
                return "Less than a minute left";
            }
        }
        
        // Update time remaining for all deadlines
        function updateTimeRemaining() {
            document.querySelectorAll('.note-deadline[data-deadline]').forEach(deadlineEl => {
                const deadline = deadlineEl.getAttribute('data-deadline');
                const timeRemainingEl = deadlineEl.querySelector('.time-remaining');
                const timeRemaining = calculateTimeRemaining(deadline);
                
                if (timeRemaining && !deadlineEl.classList.contains('overdue')) {
                    timeRemainingEl.textContent = ` (${timeRemaining})`;
                    timeRemainingEl.style.color = '#059669';
                    timeRemainingEl.style.fontWeight = '500';
                    timeRemainingEl.style.fontSize = '12px';
                } else {
                    timeRemainingEl.textContent = '';
                }
            });
        }
        
        // Update time remaining on page load and every minute
        document.addEventListener('DOMContentLoaded', function() {
            updateTimeRemaining();
            setInterval(updateTimeRemaining, 60000); // Update every minute
        });

        // View toggle functionality
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const view = this.dataset.view;
                const container = document.getElementById('notesContainer');
                container.className = view === 'list' ? 'notes-list' : 'notes-grid';
            });
        });

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function toggleTodoCompletion(todoId) {
            const noteItem = document.querySelector(`[data-todo-id="${todoId}"]`);
            const toggleBtn = noteItem.querySelector('.complete-btn');
            
            fetch(`/toggle-todo/${todoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.completed) {
                        noteItem.classList.add('completed');
                        toggleBtn.classList.add('completed');
                        toggleBtn.innerHTML = '<i class="fas fa-undo"></i>';
                    } else {
                        noteItem.classList.remove('completed');
                        toggleBtn.classList.remove('completed');
                        toggleBtn.innerHTML = '<i class="fas fa-check"></i>';
                    }
                    showToast(data.message || 'Note updated!', 'success');
                } else {
                    showToast(data.message || 'Something went wrong', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred', 'error');
            });
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                background: type === 'success' ? '#10b981' : '#ef4444',
                color: 'white',
                borderRadius: '12px',
                boxShadow: '0 8px 32px rgba(0,0,0,0.1)',
                zIndex: '1000',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                animation: 'slideInRight 0.3s ease-out',
                backdropFilter: 'blur(10px)',
                fontSize: '14px',
                fontWeight: '500'
            });
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        document.querySelector('textarea[name="task"]').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    </script>

    <style>
        .note-distractions {
            margin-top: 10px;
            padding: 8px;
            background-color: #fff7cc;
            border-left: 4px solid #facc15;
            font-size: 14px;
            line-height: 1.4;
            border-radius: 4px;
        }

        .distraction-item {
            margin: 0;
            color: #6b4c00;
        }
        
        .time-remaining {
            display: inline-block;
            color: #059669 !important;
            font-weight: 500;
            font-size: 12px;
            margin-left: 5px;
            padding: 2px 6px;
            background-color: rgba(5, 150, 105, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(5, 150, 105, 0.2);
        }
        
        .note-deadline.overdue .time-remaining {
            display: none;
        }
    </style>
</body>
</html>
